# Lumixa Manufacturing System (LMS)  
## Полное ТЗ / PRD+SRS (Living Spec)

### Версия документа
v0.1 (основной каркас требований, расширяемый по мере разработки)

### Цель документа
Дать разработчику (Claude/команде) исчерпывающую картину:
- что за система создаётся,
- из каких модулей состоит,
- какие сущности и процессы в ней есть,
- какие user-flow должны поддерживаться,
- как всё взаимодействует,
- какие требования к безопасности/надёжности/деплою,
- какие требования к отладке/диагностике после проблем первой итерации.

---

## Оглавление

1. [Введение и видение продукта](#1-введение-и-видение-продукта)  
2. [Область применения и границы (Scope / Out of scope)](#2-область-применения-и-границы)  
3. [Развёртывание и инфраструктура (без Docker)](#3-развёртывание-и-инфраструктура-без-docker)  
4. [Технологические требования (стек и подход)](#4-технологические-требования-стек-и-подход)  
5. [Роли пользователей и права доступа (RBAC)](#5-роли-пользователей-и-права-доступа-rbac)  
6. [Общая архитектура и взаимодействие модулей](#6-общая-архитектура-и-взаимодействие-модулей)  
7. [Данные и принцип хранения (MySQL как единственный источник истины)](#7-данные-и-принцип-хранения)  
8. [Модуль 1: Аутентификация, безопасность, аудит](#8-модуль-1-аутентификация-безопасность-аудит)  
9. [Модуль 2: Админка (управление пользователями, правами, полями, шаблонами, workflow)](#9-модуль-2-админка-no-code)  
10. [Модуль 3: Номенклатура (SKU) и справочники](#10-модуль-3-номенклатура-sku-и-справочники)  
11. [Модуль 4: Склад и бухгалтерия (документы, партии, остатки, резервы)](#11-модуль-4-склад-и-бухгалтерия)  
12. [Модуль 5: Каталог изделий (Product/Variant)](#12-модуль-5-каталог-изделий-productvariant)  
13. [Модуль 6: BOM (полный состав) + ревизии](#13-модуль-6-bom-полный-состав--ревизии)  
14. [Модуль 7: Routing / маршрутно-операционные карты + ревизии](#14-модуль-7-routing-маршрутно-операционные-карты--ревизии)  
15. [Модуль 8: Производство (production orders, задачи, статусы)](#15-модуль-8-производство)  
16. [Модуль 9: Очередь печати / Print Queue](#16-модуль-9-print-queue-синхронизация-со-складом)  
17. [Модуль 10: Себестоимость (плановая и фактическая)](#17-модуль-10-себестоимость)  
18. [Модуль 11: Резервное копирование и восстановление (DB+файлы)](#18-модуль-11-backup--restore)  
19. [UX/Навигация/Экраны (структура интерфейса)](#19-uxнавигацияэкраны)  
20. [Полные User-flow по всем уровням](#20-полные-user-flow-подробно)  
21. [Нефункциональные требования](#21-нефункциональные-требования)  
22. [Логи и диагностика](#22-логи-и-диагностика)  
23. [Definition of Done (критерии готовности MVP)](#23-definition-of-done-mvp)  
24. [Roadmap (MVP → v1 → vNext)](#24-roadmap)  
25. [Открытые вопросы и допущения (TODO)](#25-открытые-вопросы-и-допущения-todo)  
26. [Режим отладки (Debug Mode) и диагностический контур](#26-режим-отладки-debug-mode-и-диагностический-контур)  
27. [Страница диагностики (Diagnostics / Debug Dashboard)](#27-страница-диагностики-diagnostics--debug-dashboard)  
28. [Health Checks и Self-tests (самопроверка системы)](#28-health-checks-и-self-tests-самопроверка-системы)  
29. [Улучшения обработки ошибок (после “не заработало”)](#29-улучшения-обработки-ошибок-must-have)  
30. [Требования к первому запуску (Setup Wizard Hardening)](#30-требования-к-первому-запуску-setup-wizard-hardening)  
31. [Задачи для Claude (чтобы код запускался стабильно)](#31-задачи-для-claude)  
32. [Дополнение к Definition of Done (MVP)](#32-дополнение-к-definition-of-done-mvp)  

---

## 1. Введение и видение продукта

### 1.1 Что создаём
Создаём продуктовый веб-софт **Lumixa Manufacturing System (LMS)** — систему для **работы, учёта и взаимодействия** при производстве ламп Lumixa.

### 1.2 Главная идея
В одном приложении должны жить:
- **профессиональный склад/бухгалтерия** (материалы, партии, приходы/списания и т.д.),
- **каталог изделий** (лампы и их варианты),
- **полный состав изделия (BOM)** с версиями,
- **маршрутно-операционные карты (Routing)** с версиями,
- **планирование производства** (заказы на выпуск, задачи),
- **очередь печати** с резервированием материала и списанием по факту,
- **себестоимость** (плановая и фактическая),
- **админка no-code** (поля/шаблоны/статусы/права) хранится в MySQL, чтобы обновления кода не ломали кастомизацию,
- **бэкапы** базы и файлов с восстановлением.

---

## 2. Область применения и границы

### 2.1 In scope (в рамках системы)
- Учёт материалов, пластика, покупных компонентов, расходников, упаковки.
- Учёт партий (особенно для пластика: материал + цвет + партия).
- Документальный учёт (приход/списание/перемещение/инвентаризация).
- Каталог изделий (Product/Variant).
- BOM с ревизиями и нормами расхода.
- Routing с ревизиями, операциями, инструкциями и чек-листами.
- Производственные заказы и задачи.
- Print Queue с резервами и списаниями, синхронизация с бухгалтерией/складом.
- Расчёт себестоимости ламп: план/факт.
- Админка: пользователи/роли/права + динамические поля/шаблоны/воркфлоу.
- Бэкап/восстановление: MySQL + загруженные файлы.

### 2.2 Out of scope (пока не обязательно, но можно заложить места)
- Полная интеграция с WooCommerce (можно оставить “placeholder” или минимальный модуль на будущее).
- Автоматический сбор данных с 3D-принтеров и телеметрия (если понадобится позже).
- Сложный бухгалтерский учет по стандартам ERP (проводки, счета) — пока достаточно документального склада + себестоимость.
- Мульти-филиальные настройки и распределённые склады (можно предусмотреть, но не требовать в MVP).

---

## 3. Развёртывание и инфраструктура (без Docker)

### 3.1 Где будет жить приложение
На поддомене сайта `lumixa.io` (точное имя пока не определено). Пример: `lms.lumixa.io`.

### 3.2 Модель деплоя
- Классическое веб-приложение.
- Размещается на веб-сервере (Nginx/Apache).
- Точка входа: `public/index.php` (или аналог).
- MySQL на той же машине или доступен по сети.
- Важно: **никаких Docker/Compose** как обязательного требования.

### 3.3 Установка
- Загрузка файлов на сервер.
- Настройка web root на `/public`.
- Выдача прав записи на:
  - `/storage` (логи, бэкапы)
  - `/public/uploads` (пользовательские файлы)
- Первый запуск через `Setup Wizard` на URL `/setup`.

---

## 4. Технологические требования (стек и подход)

### 4.1 Выбор языка/стека
Можно реализовать на PHP как основной и максимально простой для хостинга. Допускаются другие стабильные стеки, но условие остаётся:
- можно развернуть на сервере “залил файлы — открыл сайт”.

### 4.2 Принципы кода
- Чёткая модульность: Catalog/Warehouse/Production/Costing/Admin/Backup.
- “Thin controllers, fat services”: бизнес-логика в сервисах.
- Репозитории (слой доступа к БД) отделены от бизнес-логики.
- Валидация входных данных на сервере.
- Транзакционность для операций склада, резервов, списаний, восстановления.

---

## 5. Роли пользователей и права доступа (RBAC)

### 5.1 Роли
- **Admin**: система, пользователи, права, кастомные поля/шаблоны, workflow, бэкапы.
- **Accountant/Warehouse**: склад, документы, партии, остатки, контрагенты.
- **Manager**: изделия, BOM, routing, производство, себестоимость, планирование.
- **Worker**: выполнение задач, работа с очередью печати в рамках дозволенного.
- (Опционально) **Viewer**: чтение без изменений.

### 5.2 RBAC обязательный
- Каждое действие (просмотр/создание/редактирование/проведение/восстановление) защищено правами.
- Права назначаются через роли.
- Смена статуса (workflow transition) может требовать отдельного permission.

---

## 6. Общая архитектура и взаимодействие модулей

### 6.1 Компоненты
1) **Web UI (Frontend)**: серверный рендер + динамика через JS по необходимости.  
2) **Backend (Server App)**: API + страницы.  
3) **MySQL**: хранение всех данных (core + metadata + audit).  
4) **File Storage**: uploads и backups на сервере.

### 6.2 Взаимодействие
- UI обращается к backend (страницы и/или API).
- Backend читает/пишет в MySQL.
- Склад влияет на Print Queue (остатки/резервы/списания).
- BOM+Routing влияет на производство, задачи и себестоимость.
- Admin metadata влияет на UI и поля сущностей.

---

## 7. Данные и принцип хранения

### 7.1 Единый источник истины
**MySQL — единственный источник истины.**  
Никакого хранения состояния приложения в браузере.

### 7.2 Кастомизация хранится в MySQL
- добавленные поля
- шаблоны карточек/таблиц
- статусы и переходы workflow
- права и роли

---

## 8. Модуль 1: Аутентификация, безопасность, аудит

### 8.1 Аутентификация
- Логин/логаут
- Сессии (cookie), безопасные настройки
- Принудительная смена пароля при первом входе (желательно)
- Ограничение попыток входа (rate limiting)

### 8.2 Защита
- CSRF защита для форм
- Валидация входных данных
- XSS защита (экранирование)
- SQL injection защита (prepared statements)
- Защита от доступа к системным папкам (config/storage/vendor и т.д.)

### 8.3 Audit log
Фиксировать ключевые действия:
- проведение документов
- создание/изменение BOM/Routing ревизий
- резервирование/списание материалов
- restore backup
- изменения прав/ролей/пользователей/кастомных полей

Audit должен хранить:
- кто сделал
- что сделал
- когда
- над какой сущностью
- по возможности diff (до/после)

---

## 9. Модуль 2: Админка (no-code)

### 9.1 Пользователи и роли
- CRUD пользователей
- назначение ролей
- блокировка пользователя
- сброс пароля (или принудительная смена)

### 9.2 Права (permissions)
- список permission codes
- привязка permission → role
- права на:
  - модули
  - сущности
  - действия (create/read/update/delete/post/restore…)

### 9.3 Динамические поля (Custom Fields)
Админ может добавлять/убирать поля для сущностей без изменения кода.

**Сущности для кастомизации (минимум):**
- Items (SKU)
- Lots/Batches
- Products
- Variants
- BOM Lines
- Routing Operations
- Documents
- Document Lines
- Tasks
- Print Jobs
- Partners

**Типы полей:**
- string/text
- number
- boolean
- date/datetime
- enum (select)
- reference (link to entity)
- file

**Настройки:**
- обязательность
- дефолтное значение
- правила валидации
- видимость/редактирование по ролям

**Хранение:**
- определения полей в таблице custom_fields
- значения в custom_values

### 9.4 Шаблоны UI (UI Templates)
Админ настраивает:
- какие колонки видны в списках
- какие секции/поля видны в карточке
- порядок полей
- видимость по ролям

Шаблоны хранятся в БД.

### 9.5 Workflow (статусы и переходы)
Админ может определять:
- статусы задач
- статусы документов
- статусы print jobs
- разрешённые переходы
- какой permission нужен для перехода

---

## 10. Модуль 3: Номенклатура (SKU) и справочники

### 10.1 SKU типы
- Material (пластик)
- Component (покупное)
- Part (детали, включая печатные)
- Consumable (расходники)
- Packaging (упаковка)

### 10.2 Карточка SKU
- SKU код
- название
- тип
- единица измерения (граммы/штуки/метры)
- атрибуты (цвет, диаметр, бренд и т.д.) — через core + custom fields
- статус активности
- вложения (опционально): фото/даташит

---

## 11. Модуль 4: Склад и бухгалтерия

### 11.1 Контрагенты
- поставщики/покупатели
- контакты
- реквизиты (опционально)

### 11.2 Склады и локации
- минимум один склад
- опционально: локации (полки/ячейки)

### 11.3 Партии (Lots)
Особенно важно для пластика:
- партия
- цвет
- дата прихода
- поставщик
- цена закупки (если нужно для стоимости)

### 11.4 Остатки и доступность
- on_hand (на руках)
- reserved (в резерве)
- available = on_hand - reserved

### 11.5 Документы движения
**Типы документов:**
- Receipt (приход)
- Issue/Write-off (списание)
- Transfer (перемещение)
- Stocktake (инвентаризация)

**Статусы:**
- Draft → Posted → Cancelled (по правилам)

**Проведение (Posting engine):**
- проведение изменяет остатки
- создаёт immutable записи postings (желательно)
- пишет audit

---

## 12. Модуль 5: Каталог изделий (Product/Variant)

### 12.1 Product
- модель изделия (лампа)
- статус

### 12.2 Variant
- вариант: цвет/размер/версия/комплектация
- атрибуты варианта (custom fields)
- связь с активной BOM ревизией
- связь с активной Routing ревизией

---

## 13. Модуль 6: BOM (полный состав) + ревизии

### 13.1 BOM ревизии
- Rev A / Rev B …
- статусы: Draft / Active / Archived
- активная ревизия одна

### 13.2 BOM lines
- ссылка на SKU
- количество и единицы
- нормы отходов/брак (процент/фикс)
- примечание

BOM должен включать:
- пластик (в граммах + цвет)
- компоненты
- расходники
- упаковку (если считаем полную себестоимость)

---

## 14. Модуль 7: Routing (маршрутно-операционные карты) + ревизии

### 14.1 Routing ревизии
- Draft / Active / Archived
- активная одна

### 14.2 Operations (операции)
У операции:
- код/название (PRINT/ASSEMBLY/QC/PACK)
- последовательность (step number)
- инструкция (текст)
- чек-лист (пункты)
- время:
  - setup time
  - run time per unit
- требуемый ресурс (опционально: принтер/рабочее место)
- вложения (файлы/фото/PDF)

---

## 15. Модуль 8: Производство

### 15.1 Production Order
- variant
- qty planned
- due date
- статус
- ссылка на routing/bom активные версии (на момент создания)

### 15.2 Задачи (Tasks)
- создаются вручную или генерируются из routing
- тип/операция
- статус (workflow)
- исполнитель
- даты план/факт
- комментарии, вложения
- опционально: учёт фактического времени

---

## 16. Модуль 9: Print Queue (синхронизация со складом)

### 16.1 Print Job
Поля:
- что печатаем (variant или part)
- материал SKU
- цвет
- количество единиц
- плановый расход (г/шт или суммарно)
- резерв материала (граммы)
- фактический расход (граммы)
- статус
- связь с production order/task (желательно)

### 16.2 Правило резервирования
При создании/планировании print job:
1) система проверяет доступность материала/цвета на складе
2) создаёт reservation (резерв) на нужное количество
3) увеличивает reserved на складе

### 16.3 Правило списания
При завершении:
1) worker вводит фактический расход
2) система создаёт списание (issue) и уменьшает on_hand
3) резерв закрывается, reserved уменьшается
4) фактический расход идёт в расчёт фактической себестоимости

### 16.4 Ошибки/edge cases
- не хватает материала → запрет создания резерва
- фактический расход > резерв:
  - политика по умолчанию: требует permission менеджера или создаёт доп. списание с предупреждением
- отмена job → освобождение резерва

---

## 17. Модуль 10: Себестоимость

### 17.1 Плановая себестоимость (Standard)
Считается из:
- BOM материалов (цены по политике AVG по умолчанию, с возможностью FIFO позже)
- Routing трудозатрат: нормы времени * ставки
- Overhead: упрощённо (грн/час оборудования или %)

Вывод:
- себестоимость 1 шт
- себестоимость партии
- breakdown по статьям

### 17.2 Фактическая себестоимость (Actual)
Считается из:
- фактических списаний материалов (issues)
- фактического времени операций (если ведётся)
- overhead

Отчёты:
- plan vs actual
- отклонения по статьям
- себестоимость по production order и по периоду

---

## 18. Модуль 11: Backup & Restore

### 18.1 Цель
Резервное копирование:
- MySQL (вся база или выбранные таблицы)
- файлы uploads/attachments  
Хранить на сервере и давать скачать. Восстановление из архива.

### 18.2 UI
Admin → Backups:
- список бэкапов с колонками:
  - дата/время
  - кто создал
  - тип (manual)
  - содержимое (DB / Files / both)
  - размер
  - статус
  - кнопки: Download, Restore, View log, Delete (опционально)
- кнопка Create Backup:
  - include DB
  - include Files
  - режим DB: full или selected tables
  - комментарий

### 18.3 Архив и manifest
Архив содержит:
- db.sql (или набор таблиц)
- files/ (uploads)
- manifest.json (метаданные)
- logs.txt

### 18.4 Restore
- требует подтверждения
- блокирует записи на время восстановления (минимум)
- пишет audit

---

## 19. UX/Навигация/Экраны

### 19.1 Основные разделы меню
1) Dashboard  
2) Warehouse / Accounting  
   - Items (SKU)
   - Lots/Batches
   - Stock
   - Documents
   - Partners  
3) Catalog  
   - Products
   - Variants
   - BOM
   - Routing  
4) Production  
   - Production Orders
   - Tasks
   - Print Queue  
5) Costing  
   - Plan cost
   - Actual cost
   - Compare  
6) Admin  
   - Users/Roles/Permissions
   - Custom Fields
   - UI Templates
   - Workflows
   - Audit Log
   - Backups  
   - Diagnostics (см. раздел 27)

### 19.2 Требования к спискам
- поиск
- фильтры
- сортировка
- пагинация

### 19.3 Требования к карточкам сущностей
- вкладки: General / Custom Fields / History / Related
- история изменений (audit) доступна admin/manager

---

## 20. Полные User-Flow (подробно)

### 20.1 Setup flow (Admin)
1) Загрузить файлы на поддомен.  
2) Настроить web root на `/public`.  
3) Открыть сайт → `/setup`.  
4) Ввести DB доступы (host/db/user/pass).  
5) Тест соединения + проверки окружения (см. раздел 30).  
6) Создать admin пользователя.  
7) Создать таблицы (миграции).  
8) Seed: роли, права, базовые workflow, базовые templates.  
9) Перейти на login, войти, сменить пароль.  

### 20.2 Admin customization flow
1) Admin → Users: создать пользователей.  
2) Admin → Roles: назначить роли.  
3) Admin → Permissions: настроить права.  
4) Admin → Custom Fields: добавить поле “Диаметр” для пластика.  
5) Admin → UI Templates: добавить “Диаметр” в карточку SKU.  
6) Admin → Workflows: настроить статусы Print Job.  

### 20.3 Warehouse receiving flow (Accountant)
1) Создать SKU пластика “PLA Transparent Black”.  
2) Создать документ Receipt (Draft).  
3) Добавить строку: пластик, партия, цвет, qty, цена.  
4) Save draft.  
5) Post document.  
6) Stock: on_hand увеличился, available вырос.  

### 20.4 Catalog creation flow (Manager)
1) Catalog → Products: создать “Lumixa P1”.  
2) Создать Variant “P1 / Transparent Black / M”.  
3) Создать BOM Rev A:
   - пластик 300g
   - компонент 1 pcs
   - упаковка 1 set  
4) Активировать BOM.  
5) Создать Routing Rev A:
   - PRINT
   - ASSEMBLY
   - QC
   - PACK  
6) Активировать routing.  
7) Открыть Variant → увидеть плановую себестоимость.  

### 20.5 Production order flow
1) Production → Create order: Variant + qty.  
2) Generate tasks from routing.  
3) Worker видит задачи по операциям.  

### 20.6 Print job flow (Worker)
1) Print Queue → Create print job.  
2) Выбрать variant/part, материал, цвет, qty, planned grams.  
3) Система проверяет available.  
4) Система создаёт reservation, reserved растёт.  
5) Worker печатает.  
6) Worker завершает job, вводит actual grams.  
7) Система списывает материал (Issue), on_hand уменьшается, reserved уменьшается/закрывается.  
8) Факт идёт в actual costing.  

### 20.7 Task completion flow
1) Worker отмечает этапы сборки, QC, упаковки.  
2) В QC чек-лист фиксируется.  
3) Order закрывается.  

### 20.8 Costing review flow
1) Manager открывает Costing.  
2) Смотрит plan cost breakdown.  
3) Смотрит actual по order.  
4) Сравнивает delta.  

### 20.9 Backup flow (Admin)
1) Admin → Backups → Create.  
2) Выбирает DB+Files.  
3) Создание → лог/статус.  
4) Backup появляется в списке с размером.  
5) Download.  
6) Restore с подтверждением.  

---

## 21. Нефункциональные требования

### 21.1 Безопасность
- RBAC везде
- CSRF на формы
- подготовленные запросы в БД
- защита от доступа к приватным папкам
- ограничение restore/backup

### 21.2 Надёжность
- транзакции для складских операций
- защита от “двойного проведения” документа
- понятные ошибки и rollback

### 21.3 Производительность
- пагинация и фильтры
- индексы в БД на частые запросы

---

## 22. Логи и диагностика
- системные логи в `/storage/logs`
- UI для просмотра логов бэкапов
- audit log UI

---

## 23. Definition of Done (MVP)

Система готова, если:
- ставится без Docker через setup wizard
- есть логин и RBAC
- склад: SKU+documents+posting+stock
- каталог: product/variant + BOM revisions + routing revisions
- производство: production orders + tasks (минимум)
- print queue: резерв → фактический расход → списание
- costing: план и факт (базово)
- admin customization: custom fields + templates + workflows в БД
- backup: создать/список/скачать/восстановить
- audit фиксирует ключевые операции

---

## 24. Roadmap

### MVP
- всё из DoD выше

### v1
- расширенные отчёты
- более умные workflow/автоматизации
- улучшенный actual costing (время операций)

### vNext
- интеграции (WooCommerce)
- импорт/экспорт
- расширение складов/локаций

---

## 25. Открытые вопросы / TODO (фиксируем)
- Политика стоимости материалов: AVG (по умолчанию) или FIFO (позже)
- Учет времени операций: вручную или не в MVP
- Overhead модель: упрощённая (грн/час) или % труда

---

## 26. Режим отладки (Debug Mode) и диагностический контур

### 26.1 Цель
Добавить в систему встроенный **режим отладки и диагностики**, чтобы:
- быстро выявлять причины “не запускается / белый экран / 500”,
- видеть корректность окружения (PHP/MySQL/права),
- проверять подключение к БД, миграции, доступность директорий,
- иметь журнал действий и ошибок в удобном виде,
- минимизировать время на разбор проблем при деплое и обновлениях.

### 26.2 Принцип включения режима отладки
- Режим отладки должен включаться **через конфиг**, например:
  - `APP_ENV=prod|dev`
  - `APP_DEBUG=true|false`
- В `prod`:
  - ошибки не показываются пользователю (только “Something went wrong”)
  - подробности пишутся в лог
- В `dev`:
  - можно показывать расширенные сообщения (stack trace) **только администратору**
  - обязательно защищено авторизацией (см. ниже)

### 26.3 Защита Debug
- Все debug-страницы и debug-эндпоинты доступны:
  - только с логином администратора **и**
  - только при включённом `APP_DEBUG=true`
- Дополнительно (желательно):
  - whitelist IP (опционально, как настройка)

---

## 27. Страница диагностики (Diagnostics / Debug Dashboard)

### 27.1 Раздел и URL
Добавить раздел в админке: **Admin → Diagnostics**  
или отдельный URL: `/admin/diagnostics`

### 27.2 Состав диагностической страницы
Страница должна показывать:

#### A) Информация об окружении
- Версия PHP (CLI и Web если возможно)
- Версия приложения (git hash/версия релиза)
- Время сервера / timezone
- Путь к `public/`, `storage/`, `uploads/`
- Конфигурация `APP_ENV`, `APP_DEBUG`

#### B) Проверка прав на директории (must-have)
- `storage/` writable? ✅/❌  
- `storage/logs/` writable? ✅/❌  
- `storage/backups/` writable? ✅/❌  
- `public/uploads/` writable? ✅/❌  
- Рекомендации что именно `chmod/chown` сделать (текстом)

#### C) Проверка PHP расширений (must-have)
- PDO MySQL
- mbstring
- openssl
- json
- zip (для backup)
- curl (если понадобится)
Каждое: ✅/❌ и подсказка “как установить”.

#### D) Проверка БД
- Status: connected / failed
- host/db/user (без пароля)
- Ping query (SELECT 1)
- Проверка наличия базовых таблиц (users, migrations, items…)
- Показ текущей схемы/версии миграций

#### E) Проверка миграций
- Текущая версия БД (например, `schema_version` или последняя миграция)
- Список pending migrations (если есть)
- Кнопки:
  - “Run pending migrations” (только admin)
  - “Re-check schema”
- Лог выполнения миграций на странице

#### F) Проверка маршрутизации
- Проверка, что rewrite/try_files работает:
  - запрос к тестовому route `/health` отдаёт 200
- Если нет — подсказка “настрой web root /public и rewrite”

#### G) Просмотр логов
- Последние N строк `storage/logs/app.log`
- Фильтр по уровню (ERROR/WARN/INFO)
- Кнопка “Download logs” (как файл)
- В отдельной вкладке: логи backup/restore

---

## 28. Health Checks и Self-tests (самопроверка системы)

### 28.1 Endpoint: /health (публичный без деталей)
- `GET /health`
- Возвращает: `200 OK` и коротко `OK`
- Без утечек конфигурации

### 28.2 Endpoint: /health/details (только admin + debug)
- Возвращает JSON или страницу с результатами checks:
  - db connection
  - migrations status
  - writable dirs
  - required php extensions

### 28.3 Self-test Runner (кнопка “Run self-tests”)
На странице Diagnostics:
- кнопка запускает набор тестов:
  1) DB: `SELECT 1`
  2) Create temp record in test table (или транзакция rollback)
  3) Проверка создания файла в `storage/logs`
  4) Проверка создания архива zip в `storage/backups` (без реального бэкапа)
  5) Проверка генерации CSRF token
- Результат выводится списком ✅/❌ + подробности

---

## 29. Улучшения обработки ошибок (must-have)

### 29.1 Глобальный error handler
Добавить централизованную обработку ошибок:
- capture exceptions
- capture fatal errors (shutdown handler)
- запись в лог с `request_id`
- отображение:
  - prod: короткое сообщение
  - dev: подробности только admin

### 29.2 Request ID
Для каждого HTTP запроса генерировать `request_id`:
- писать в лог
- показывать в error page (например “Error ID: abc123”)

### 29.3 Страница “Ошибка” с инструкцией
Если произошла ошибка:
- показать “Произошла ошибка”
- показать request-id
- подсказка “Откройте Admin → Diagnostics → Logs”

---

## 30. Требования к первому запуску (Setup Wizard Hardening)

### 30.1 Setup Wizard должен проверять всё до установки
Перед созданием таблиц:
- writable dirs
- php extensions
- доступность БД
- корректность timezone
- корректность web root (`public/`)

### 30.2 Fail-fast и понятные ошибки
Если что-то не так — показать:
- что именно не так
- как исправить (команды)
- пример конфигурации nginx/apache

### 30.3 “Dry-run install”
Добавить режим “Dry run”:
- выполняет все проверки
- НЕ создает таблицы
- полезно при деплое

---

## 31. Задачи для Claude (чтобы код запускался стабильно)

### 31.1 Задача: “Стабильный старт и диагностический контур”
Claude должен:

1) **Сделать минимальный стабильный boot**:
- `public/index.php` всегда возвращает страницу (даже если БД не настроена → редирект на `/setup`)
- исключить “white screen” (включить error handler + лог)

2) **Реализовать Diagnostics Dashboard** (см. раздел 27) в Admin.

3) **Реализовать health endpoints**:
- `/health`
- `/health/details` (admin+debug)

4) **Сделать setup wizard с проверками**:
- проверки окружения до миграций
- fail-fast с подсказками
- dry-run режим

5) **Сделать логирование**:
- `storage/logs/app.log`
- уровни логов
- request-id

6) **Сделать “dev/prod” режимы**:
- `APP_ENV`, `APP_DEBUG`
- dev подробности только admin

7) **Добавить “Debug panel” на страницах (только dev+admin)**:
- текущий пользователь/роль
- текущий route
- время рендера
- количество SQL запросов (минимально)

---

## 32. Дополнение к Definition of Done (MVP)

Добавить к DoD следующие пункты:

- ✅ При неправильных правах/отсутствующих расширениях система показывает понятную страницу диагностики/ошибки, а не белый экран.
- ✅ Есть `/health` → `200 OK`.
- ✅ Есть Admin → Diagnostics с полной картиной окружения и кнопками self-test.
- ✅ Setup wizard делает проверки до установки и показывает инструкции исправления.
- ✅ Любая ошибка пишет request-id и подробности в лог.
